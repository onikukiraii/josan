# シフト生成アルゴリズム

## 使用ソルバー

Google OR-Tools CP-SAT

## 決定変数

```
x[member][date][shift_type] ∈ {0, 1}
```

メンバー m が日付 d にシフト s に割り当てられるかどうか。

## ハード制約

| # | 制約内容 |
|---|---|
| H1 | 1人1日1シフト（day_off を含む） |
| H2 | 各ポジションの必要人数を満たす（[配置ルール](./02_配置ルール.md) 参照） |
| H3 | 各ポジションのフラグ・職能制約を満たす |
| H4 | 日勤不可のメンバーは日勤系シフトに入らない |
| H5 | 夜勤不可のメンバーは夜勤系シフトに入らない |
| H6 | 夜勤翌日は必ず休み |
| H7 | NGペアは同日の夜勤に同時配置しない |
| H8 | 夜勤2名のうち最低1名は助産師 |
| H9 | 連続勤務は最大5日（6日間で最低1日休み） |
| H10 | 夜勤回数 ≤ 個人の月間上限 |
| H11 | 公休日数: 常勤は月の規定日数と一致（deduction_balance 考慮）、非常勤は最低保証（>=） |
| H12 | 希望休を守る（Step 1 ではハード制約） |
| H13 | 新人が病棟配置の日は病棟系5名体制 |
| H14 | 日祝は病棟系のみ稼働 |

## ソフト制約（目的関数）

| # | 制約内容 | 最適化方針 |
|---|---|---|
| S1 | 希望休を最大限叶える（Step 2） | 叶えた数を最大化 |
| S2 | 夜勤回数の均等化 | max-min 差を最小化 |
| S3 | 日祝出勤の均等化 | max-min 差を最小化 |

## 後処理

| # | 処理内容 |
|---|---|
| P1 | 日勤配置後、未割り当ての日勤者がいれば処置室に追加配置 |

## 段階的求解戦略

1. **Step 1:** 全ての希望休をハード制約として求解。解が見つかれば完了。
2. **Step 2:** 解なしの場合、希望休をソフト制約に切り替え、叶えた希望休の数を最大化する目的関数で再求解。
3. **Step 3:** 叶えられなかった希望休がある場合、対象メンバーと日付を管理者に報告。

## エラー診断

Step 2 でも解が見つからない場合、以下の事前診断を実行し、具体的な原因をエラーメッセージとして返す。

| # | 診断項目 |
|---|---|
| D1 | 各ポジションに配置可能なメンバーが必要人数を満たしているか |
| D2 | 夜勤枠の月間合計に対して、メンバーの夜勤上限合計が足りているか |
| D3 | 夜勤リーダー可能メンバーの夜勤上限合計で毎日カバーできるか |
| D4 | 夜勤可能な助産師の夜勤上限合計で毎日1名確保できるか |
| D5 | 日勤帯の必要枠に対して、勤務可能日数が足りているか |
| D6 | 各メンバーが勤務日数を埋められるか（夜勤のみ可能なメンバーの日数不足等） |
